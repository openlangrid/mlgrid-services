<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
  <div class="row"><div class="col">
    <ul class="nav nav-tabs" id="menuTab" role="tablist">
      <!-- 翻訳サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="transTab" data-bs-toggle="tab" data-bs-target="#trans"
          type="button" role="tab" aria-controls="trans" aria-selected="true">Translation</button>
      </li>
      <!-- 画像識別サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="icTab" data-bs-toggle="tab" data-bs-target="#ic"
          type="button" role="tab" aria-controls="ic" aria-selected="false">ImageClassification</button>
      </li>
      <!-- オブジェクト検出サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="odTab" data-bs-toggle="tab" data-bs-target="#od"
          type="button" role="tab" aria-controls="od" aria-selected="false">ObjectDetection</button>
      </li>
      <!-- 画像生成サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="igTab" data-bs-toggle="tab" data-bs-target="#ig"
          type="button" role="tab" aria-controls="ig" aria-selected="false">TextImageGeneration</button>
      </li>
      <!-- テキスト感情分析サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tsaTab" data-bs-toggle="tab" data-bs-target="#tsa"
          type="button" role="tab" aria-controls="tsa" aria-selected="false">TextSentimentAnalysis</button>
      </li>
    </ul>
    <div class="tab-content" id="tabContent">
      <!-- 翻訳サービス -->
      <div class="tab-pane fade show active" id="trans" role="tabpanel" aria-labelledby="transTab">
        <label>sourceLang<input id="sourceLang" class="form-control" type="text" value="en"></label>
        <label>targetLang<input id="targetLang" class="form-control" type="text" value="ja"></label>
        <label>source<input id="source" class="form-control" type="text" value="hello"></label>
        <button id="execute" class="btn btn-success">翻訳</button>
        <br/>
        <label>results:</label><br/>
		<div id="transServices">
		</div>
		<a href="https://langrid.org">Language Grid</a>
		<a href="https://huggingface.co/Helsinki-NLP">Helsinki-NLP</a>
      </div>
      <!-- 画像識別サービス -->
      <div class="tab-pane fade" id="ic" role="tabpanel" aria-labelledby="icTab">
        <button id="icButton" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
        <img id="icImage" style="max-height: 360px; object-fit: scale-down;">
        <br/>
        <label>results:</label><br/>
		<div id="icServices">
		</div>
        <a href="https://www.tensorflow.org/api_docs/python/tf/keras">tf.keras</a>
      </div>
      <!-- 物体検出サービス -->
      <div id="od" aria-labelledby="odTab" class="tab-pane fade" role="tabpanel">
        <button id="odButton" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
        <img id="odImage" style="max-height: 360px; object-fit: scale-down;">
        <br/>
        <label>results:</label><br/>
		<div id="odServices">
		</div>
		<br/>
        <a href="https://github.com/ultralytics/yolov5">YoloV5</a>
      </div>
      <!-- テキスト画像生成サービス -->
      <div id="ig" aria-labelledby="igTab" class="tab-pane fade" role="tabpanel">
        <label>language<input data-id="language" class="form-control" type="text" value="en"></label>
        <label>text<input data-id="text" class="form-control" type="text" value="sunset over a lake in the mountains"></label>
        <button data-id="execute" class="btn btn-success">生成</button>
        <br/>
        <label>results:</label><br/>
		<div data-id="services">
		</div>
		<template data-id="resultTemplate">
		  <div style="display: inline-block">
			<img><br/><span></span>
		  </div>
		</template>
		<br/>
        <a href="https://github.com/borisdayma/dalle-mini">Dalle Mini</a>
      </div>
      <!-- テキスト感情分析サービス -->
      <div id="tsa" aria-labelledby="tsaTab" class="tab-pane fade" role="tabpanel">
        <label>language<input data-id="language" class="form-control" type="text" value="ja"></label>
        <label>text<input data-id="text" class="form-control" type="text" value="今日はいい天気ですね"></label>
        <button data-id="execute" class="btn btn-success">分析</button>
        <br/>
        <label>results:</label><br/>
		<div data-id="services">
		</div>
		<br/>
        <a href="https://github.com/cl-tohoku/bert-japanese/tree/v1.0">BERT Models for Japanese NLP</a>
      </div>
    </div>
  </div></div>
</div>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-bson/2.0.8/bson.min.js" integrity="sha512-3NRCDv4HSFtMd3OLtUOPmxOceZQuCtfhhGaTn3BpCn+wDEDRWOWeNGjL2Ahd6IrvlhH6kBpAHRzeU3AfKKvzkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-bson/2.0.8/bson.js" integrity="sha512-qj4zC8FelR9yOqMc29m3TEARellBmX1gse6toliCJJ9vO8Pgy6FaFUwd/UU02Jv3U2ZTyKIjRe1+GQmUPDLAEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
-->
<script src="bson.js"></script>
<script>
//const baseUrl = "https://langrid.org/mlgrid-services/services";
//const baseUrl = "http://localhost:8080/mlgrid-services/services";
const baseUrl = "services";

function round(v, n){
	const s = Math.pow(10, n);
	return Math.round(v * s) / s;
}

function roundBox(v, n){
	return {x: round(v.x, n), y: round(v.y, n),
		width: round(v.width, n), height: round(v.height, n)};
}

window.addEventListener("load", ()=>{
	const transServiceIds = ["LangridGoogleTranslateNMT", "HelsinkiNLPOpusMT"];
	const icServiceIds = ["KerasEfficientNetV2B0", "KerasResNet50", "KerasVGG19"];
	const odServiceIds = ["YoloV5n", "YoloV5s", "YoloV5m", "YoloV5l", "YoloV5x"];
//	const igServiceIds = ["DummyTextImageGeneration"];
	const igServiceIds = ["DalleMiniMega1Fp16", "DalleMiniMini1"];
	const tsaServiceIds = ["ClTohokuSentimentAnalysis"];

	const bson = new BSON();
	const loc = document.location;
	const proto = loc.protocol == "https:" ? "wss" : "ws";
	const wsUrl = `${proto}://${loc.host}/${loc.pathname.split("/")[1]}/ws`
	console.log(wsUrl);
	const ws = new WSInvoker(wsUrl);

	const trans = document.querySelector("#trans");
	const transServices = document.querySelector("#transServices");
	const transResults = {};
	for(let sid of transServiceIds){
		transServices.append(document.createTextNode(`${sid}: `));
		const r = document.createElement("span");
		transResults[sid] = r;
		transServices.append(r);
		transServices.append(document.createElement("br"));
	}
	trans.querySelector("#execute").addEventListener("click", e=>{
		e.preventDefault();
		const sl = trans.querySelector("#sourceLang").value;
		const tl = trans.querySelector("#targetLang").value;
		const source = trans.querySelector("#source").value;
		for(let sid of transServiceIds){
			const result = transResults[sid];
			result.textContent = "processing...";
			ws.translate(sid, sl, tl, source)
				.then(r=>{ console.log(r); result.textContent = r.result; })
				.catch(e=>{ console.error(e); result.textContent = r.error; });
		}
	});

	const ic = document.querySelector("#ic");
	const icServices = ic.querySelector("#icServices");
	const icResults = {};
	for(let sid of icServiceIds){
		icServices.append(document.createTextNode(`${sid}: `));
		const r = document.createElement("span");
		icResults[sid] = r;
		icServices.append(r);
		icServices.append(document.createElement("br"));
	}
	const icButton = ic.querySelector("#icButton");
	icButton.addEventListener("dragover", e=>{
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = "link";
	});
	icButton.addEventListener("drop", e=>{
		e.preventDefault();
		const file = e.dataTransfer.files[0];
		ic.querySelector("#icImage").src = URL.createObjectURL(file);
		const fr = new FileReader();
//		fr.readAsDataURL(file);
		fr.readAsArrayBuffer(file);
		fr.addEventListener("load", e=>{
			for(let sid of icServiceIds){
				const result = icResults[sid];
				result.textContent = "processing...";
// [cat.jpg,497bytes] b64(DataURL): 663byte, bin: 497bytes
//				ws.classify(sid, "image/jpeg", fr.result.split(",")[1], "en", 10)
				ws.classify(sid, "image/jpeg", Buffer.from(new Uint8Array(fr.result)), "en", 10)
					.then(r=>{result.textContent = r.result.map(
						a=>`${a["label"]}(${round(a["accuracy"], 2)})`).join(",")})
					.catch(e=>{ console.error(e); result.textContent = e.error; });
			}
		});
	});

	const od = document.querySelector("#od");
	const odServices = od.querySelector("#odServices");
	const odResults = {};
	for(let sid of odServiceIds){
		odServices.append(document.createTextNode(`${sid}: `));
		const r = document.createElement("span");
		odResults[sid] = r;
		odServices.append(r);
		odServices.append(document.createElement("br"));
	}
	const odButton = od.querySelector("#odButton");
	odButton.addEventListener("dragover", e=>{
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = "link";
	});
	odButton.addEventListener("drop", e=>{
		e.preventDefault();
		const file = e.dataTransfer.files[0];
		od.querySelector("#odImage").src = URL.createObjectURL(file);
		const fr = new FileReader();
		fr.readAsArrayBuffer(file);
		fr.addEventListener("load", e=>{
			for(let sid of odServiceIds){
				const result = odResults[sid];
				result.textContent = "processing...";
				ws.detect(sid, "image/jpeg", Buffer.from(new Uint8Array(fr.result)), "en", 10)
					.then(r=>{result.textContent = r.result.map(
						a=>`${JSON.stringify(roundBox(a["boundingBox"], 2))},${a["label"]}(${round(a["accuracy"], 2)})`).join("\n")})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	});

	{	// TextImageGeneration
		const parent = document.querySelector("#ig");
		const services = parent.querySelector("[data-id='services']");
		const results = {};
		for(let sid of igServiceIds){
			services.append(document.createTextNode(`${sid}: `));
			const r = document.createElement("span");
			results[sid] = r;
			services.append(r);
			services.append(document.createElement("br"));
		}
		parent.querySelector("[data-id='execute']").addEventListener("click", e=>{
			e.preventDefault();
			const lang = parent.querySelector("[data-id='language']").value;
			const text = parent.querySelector("[data-id='text']").value;
			for(let sid of igServiceIds){
				const result = results[sid];
				result.textContent = "processing...";
				ws.textImageGenerate(sid, lang, text, "image/jpeg", 8)
					.then(r=>{
						console.log(r);
						console.log(r.result);
						result.textContent = "";
						result.append(document.createElement("br"));
						for(let res of r.result){
							const content = parent.querySelector("[data-id='resultTemplate']").content.cloneNode(true);
							const img = content.querySelector("img");
							img.src = URL.createObjectURL(new Blob([res.image.buffer]));
							const acc = content.querySelector("span");
							acc.textContent = "Accuracy: " + round(res.accuracy, 2);
							result.append(content);
						}
					})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	}

	{	// TextSentimentAnalysis
		const parent = document.querySelector("#tsa");
		const sids = tsaServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const results = {};
		for(let sid of sids){
			services.append(document.createTextNode(`${sid}: `));
			const r = document.createElement("span");
			results[sid] = r;
			services.append(r);
			services.append(document.createElement("br"));
		}
		parent.querySelector("[data-id='execute']").addEventListener("click", e=>{
			e.preventDefault();
			const lang = parent.querySelector("[data-id='language']").value;
			const text = parent.querySelector("[data-id='text']").value;
			for(let sid of sids){
				const result = results[sid];
				result.textContent = "processing...";
				ws.textSentimentAnalyze(sid, lang, text)
					.then(r=>{
						result.textContent = `${r.result.label}(${round(r.result.accuracy, 2)})`;
					})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	}
});

class WSInvoker{
	constructor(url){
		this.bson = new BSON();
		this.url = url;
		this.ws = null;
		this.sendbuf = [];
		this.rid = 0;
		this.handlers = {};
	}

	translate(serviceId, sl, tl, source){
		return this.invoke(serviceId, "translate",
				[sl, tl, source]);
	}
	classify(serviceId, format, image, labelLang, maxResults){
		return this.invoke(serviceId, "classify",
				[format, image, labelLang, maxResults]);
	}
	detect(serviceId, format, b64Image, labelLang, maxResults){
		return this.invoke(serviceId, "detect",
				[format, b64Image, labelLang, maxResults]);
	}
	textImageGenerate(serviceId, language, text, imageFormat, maxResults){
		return this.invoke(serviceId, "generate",
				[language, text, imageFormat, maxResults]);
	}
	textSentimentAnalyze(serviceId, language, text){
		return this.invoke(serviceId, "analyze",
				[language, text]);
	}
	invoke(serviceId, method, args){
		console.log(`${serviceId}.${method}`);
		return new Promise((resolve, reject)=>{
			const rid = this.rid++;
			const msg = {
				reqId: rid, serviceId: serviceId,
				method: method, args: args
			};
			console.log("req:", msg);
			const data = this.bson.serialize(msg);
//			const data = JSON.stringify(msg);			
			console.log("req(encoded):", data);
			this.send(data);
			this.handlers[rid] = r=>{
				resolve(r);
				delete this.handlers[rid];
			};
		});
	}

	send(data){
		this.prepareWs();
		if(this.ws.readyState == 0){
			this.sendbuf.push(data);
		} else if(this.ws.readyState == 1){
			this.ws.send(data);
		} else{
			console.error("websocket connection closing.");
		}
	}

	prepareWs(){
		if(this.ws != null) return;
		this.ws = new WebSocket(this.url);
		this.ws.binaryType = "arraybuffer";
		this.ws.addEventListener('open', e=>{
			console.log("websocket connection opened.");
			for(let b of this.sendbuf){
				this.ws.send(b);
			}
			this.sendbuf = [];
		});
		this.ws.addEventListener('close', e=>{
			console.log("websocket connection closed.");
			this.ws = null;
			this.rid = 0;
			this.handlers = {};
		});
		this.ws.addEventListener("message", e=>{
			if(e.data instanceof ArrayBuffer) {
				// binary
				const array = new Uint8Array(e.data);
				console.log("res:", array);
				const r = this.bson.deserialize(Buffer.from(array));
				console.log("res(decoded):", r);
				this.handlers[r.reqId](r);
			} else {
				// text
				console.log("res:", e.data);
				const r = JSON.parse(e.data);
				console.log("res(decoded):", r);
				this.handlers[r.reqId](r);
			}
		});
	}
}
</script>
</body>
</html>
