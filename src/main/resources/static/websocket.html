<!DOCTYPE html>
<html>
<head>
<meta charset="utf8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</head>
<body>
<br/>
<div class="container">
  <div class="alert alert-danger">アップロードされたデータはオープンソースソフトウェアで処理されたり，
	Google翻訳を含む外部サービスに送信されるとともに，研究目的で使用されます。
	データそのものが直接外部に公開されることはありませんが，個人情報や秘密情報をアップロードしないようご注意ください。</div>
  <div class="row"><div class="col">
    <ul class="nav nav-tabs" id="menuTab" role="tablist">
      <!-- 翻訳サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="transTab" data-bs-toggle="tab" data-bs-target="#trans"
          type="button" role="tab" aria-controls="trans" aria-selected="true">Translation</button>
      </li>
      <!-- 画像識別サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="icTab" data-bs-toggle="tab" data-bs-target="#ic"
          type="button" role="tab" aria-controls="ic" aria-selected="false">ImageClassification</button>
      </li>
      <!-- オブジェクト検出サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="odTab" data-bs-toggle="tab" data-bs-target="#od"
          type="button" role="tab" aria-controls="od" aria-selected="false">ObjectDetection</button>
      </li>
      <!-- 人間姿勢推定サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hpeTab" data-bs-toggle="tab" data-bs-target="#hpe"
          type="button" role="tab" aria-controls="hpe" aria-selected="false">HumanPoseEstimation</button>
      </li>
      <!-- 画像変換サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="i2iTab" data-bs-toggle="tab" data-bs-target="#i2i"
          type="button" role="tab" aria-controls="i2i" aria-selected="false">Image2ImageConversion</button>
      </li>
	  <!-- 画像テキスト生成サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="i2tTab" data-bs-toggle="tab" data-bs-target="#i2t"
          type="button" role="tab" aria-controls="i2t" aria-selected="false">Image2TextGeneration</button>
      </li>
      <!-- 画像生成サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="igTab" data-bs-toggle="tab" data-bs-target="#ig"
          type="button" role="tab" aria-controls="ig" aria-selected="false">TextGuidedImageGeneration</button>
      </li>
      <!-- テキスト画像変換サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tgiTab" data-bs-toggle="tab" data-bs-target="#tgi"
          type="button" role="tab" aria-controls="tgi" aria-selected="false">TextGuidedImageManipulation</button>
      </li>
      <!-- テキスト感情分析サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tsaTab" data-bs-toggle="tab" data-bs-target="#tsa"
          type="button" role="tab" aria-controls="tsa" aria-selected="false">TextSentimentAnalysis</button>
      </li>
      <!-- 継続型音声認識サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="csrTab" data-bs-toggle="tab" data-bs-target="#csr"
          type="button" role="tab" aria-controls="csr" aria-selected="false">ContinuousSpeechRecognition</button>
      </li>
      <!-- 音声認識サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="srTab" data-bs-toggle="tab" data-bs-target="#sr"
          type="button" role="tab" aria-controls="sr" aria-selected="false">SpeechRecognition</button>
      </li>
      <!-- 音声感情検出サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="serTab" data-bs-toggle="tab" data-bs-target="#ser"
          type="button" role="tab" aria-controls="ser" aria-selected="false">SpeechEmotionRecognition</button>
      </li>
      <!-- 音声合成サービスタブ -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="ttsTab" data-bs-toggle="tab" data-bs-target="#tts"
          type="button" role="tab" aria-controls="tts" aria-selected="false">TextToSpeech</button>
      </li>
    </ul>
    <div class="tab-content" id="tabContent">
      <!-- 翻訳サービス -->
      <div class="tab-pane fade show active" id="trans" role="tabpanel" aria-labelledby="transTab">
		<label>inputs:</label><br/>
		<div data-id="inputs">
			<label>sourceLang<input data-id="sourceLang" class="form-control" size="10" type="text" value="en"></label>
			<label>targetLang<input data-id="targetLang" class="form-control" size="10" type="text" value="ja"></label>
			<label>source<input data-id="source" class="form-control" size="80" type="text" value="hello"></label>
			<button data-id="execute" class="btn btn-success">翻訳</button>
			<br/>
		</div>
		<label>services:</label>
		<div data-id="services"></div>
		<template data-id="serviceTemplate">
			<label><input data-id="serviceIdCheck" type="checkbox" checked>&nbsp;
				<span data-id="serviceIdLabel"></span></label><br/>
		</template>
		<label>results:</label>
		<div data-id="results">
		</div>
		<template data-id="resultTemplate">
			input:<br/>
			sourceLang: <span data-id="sourceLang"></span>&nbsp;targetLang: <span data-id="targetLang"></span>
			&nbsp;soruce: <span data-id="source"></span>
			<div data-id="serviceResults">
			</div>
		</template>
		<template data-id="serviceResultTemplate">
			<span data-id="serviceId"></span>: <span data-id="result"></span><br/>
		</template>
		<a href="https://langrid.org">Language Grid</a>
		<a href="https://huggingface.co/Helsinki-NLP">Helsinki-NLP</a>
      </div>
      <!-- 画像識別サービス -->
      <div class="tab-pane fade" id="ic" role="tabpanel" aria-labelledby="icTab">
        <button id="icButton" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
        <img id="icImage" style="max-height: 360px; object-fit: scale-down;">
        <br/>
        <label>results:</label><br/>
		<div id="icServices">
		</div>
        <a href="https://www.tensorflow.org/api_docs/python/tf/keras">tf.keras</a>
      </div>
      <!-- 物体検出サービス -->
      <div id="od" aria-labelledby="odTab" class="tab-pane fade" role="tabpanel">
        <button id="odButton" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
        <img id="odImage" style="max-height: 360px; object-fit: scale-down;">
        <br/>
        <label>results:</label><br/>
		<div id="odServices">
		</div>
		<br/>
        <a href="https://github.com/ultralytics/yolov5">YoloV5</a>
      </div>
      <!-- 人間姿勢推定サービス -->
      <div id="hpe" aria-labelledby="hpeTab" class="tab-pane fade" role="tabpanel">
        <button data-id="button" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
		<div style="position: relative">
			<img data-id="image" style="max-height: 360px; object-fit: scale-down">
			<div data-id="canvases"></div>
		</div>
        <br/>
        <label>results:</label><br/>
		<div data-id="services">
		</div>
		<br/>
        <a href="https://github.com/CMU-Perceptual-Computing-Lab/openpose">OpenPose</a>
      </div>
      <!-- 画像変換サービス -->
      <div id="i2i" aria-labelledby="i2iTab" class="tab-pane fade" role="tabpanel">
        <button data-id="button" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
		<div style="position: relative">
			<img data-id="image" style="max-height: 360px; object-fit: scale-down">
			<div data-id="canvases"></div>
		</div>
        <label>services:</label><br/>
		<div data-id="services">
		</div>
		<template data-id="serviceTemplate">
			<label><input data-id="serviceIdCheck" type="checkbox" checked>&nbsp;
				<span data-id="serviceIdLabel"></span></label><br/>
		</template>
		<br/>
		<label>results:</label>
		<div data-id="results">
		</div>
		<template data-id="resultTemplate">
			<hr/>
			input: <img data-id="image" style="max-width: 512px; max-height: 512px;"></img>
			<div data-id="serviceResults">
			</div>
		</template>
		<template data-id="serviceResultTemplate">
			<span data-id="serviceId"></span>: <span data-id="status"></span><br/>
		    <img data-id="conversionResult" style="max-width: 512px; max-height: 512px;"><br/><span></span>
		</template>
        <br/>
        <a href="https://github.com/sczhou/CodeFormer">CodeFormer</a>&nbsp;
        <a href="https://github.com/xinntao/Real-ESRGAN">RealESRGAN</a>
      </div>
      <!-- 画像テキスト生成サービス -->
      <div id="i2t" aria-labelledby="i2tTab" class="tab-pane fade" role="tabpanel">
        <button data-id="button" effectAllowed="move" style="height: 4em" type="button"
         class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
        <br/>
		<label>services:</label>
		<div data-id="services">
		</div>
		<template data-id="serviceTemplate">
			<label><input data-id="serviceIdCheck" type="checkbox" checked>&nbsp;
				<span data-id="serviceIdLabel"></span></label><br/>
		</template>
		<label>results:</label>
		<div data-id="results">
		</div>
		<template data-id="resultTemplate">
			<hr/>
			input: <img data-id="image" style="max-width: 512px; max-height: 512px;"></img>
			<div data-id="serviceResults">
			</div>
		</template>
		<template data-id="serviceResultTemplate">
			<span data-id="serviceId"></span><br/>
			<div data-id="generationResult"></div>
		</template>
		<br/>
        <a href="https://github.com/pharmapsychotic/clip-interrogator">Clip Interrogator</a> &nbsp;
      </div>
      <!-- テキスト画像生成サービス -->
      <div id="ig" aria-labelledby="igTab" class="tab-pane fade" role="tabpanel">
        <label>language<input data-id="language" class="form-control" size="20" type="text" value="en"></label>
        <label>text<input data-id="text" class="form-control" size="80" type="text" value="sunset over a lake in the mountains"></label>
		<label>samples<input data-id="samples" class="form-control" type="number" min="1" max="8" value="3"></label>
        <button data-id="execute" class="btn btn-success">生成</button>
        <br/>
        <label>services:</label><br/>
		<div data-id="services">
		</div>
		<template data-id="serviceTemplate">
		  <div>
			<label data-id="serviceId" data-value="service1"><input type="checkbox" data-id="check" checked>&nbsp;</label>
			<span data-id="status"></span>
		  </div>
		</template>
		<template data-id="resultTemplate">
		  <div style="display: inline-block">
			<img><br/><span></span>
		  </div>
		</template>
		<br/>
        <a href="https://github.com/borisdayma/dalle-mini">Dalle Mini</a> &nbsp;
        <a href="https://github.com/CompVis/stable-diffusion">Stable Diffusion</a> &nbsp;
        <a href="https://github.com/harubaru/waifu-diffusion">Waifu Diffusion</a> &nbsp;
		<a href="https://github.com/rinnakk/japanese-stable-diffusion">Rinna Japanese Stable Diffusion</a> &nbsp;
		<a href="https://huggingface.co/naclbit/trinart_stable_diffusion_v2">trinart_stable_diffusion_v2</a> &nbsp;
		<a href="https://huggingface.co/sd-dreambooth-library/disco-diffusion-style">disco-diffusion-style</a> &nbsp;
		<a href="https://huggingface.co/doohickey/trinart-waifu-diffusion-50-50">trinart-waifu-diffusion-50-50</a>
      </div>
	  <!-- テキスト画像変換サービス -->
	  <div id="tgi" aria-labelledby="tgiTab" class="tab-pane fade" role="tabpanel">
	    <button data-id="button" effectAllowed="move" style="height: 4em" type="button"
		  class="btn btn-outline-success form-control">ここに画像をドロップしてください</button>
		<br/>
        <label>language<input data-id="language" class="form-control" size="20" type="text" value="en"></label>
        <label>prompt<input data-id="prompt" class="form-control" size="80" type="text" value="A fantasy landscape, trending on artstation"></label>

		<div style="position: relative">
			<img data-id="image" style="max-height: 360px; object-fit: scale-down">
		</div>
		<br/>
		<label>results:</label><br/>
		<div data-id="services">
		</div>
		<template data-id="serviceTemplate">
		  <div>
		    <label data-id="serviceId" data-value="service1"><input type="checkbox" data-id="check" checked>&nbsp;</label>
			<span data-id="status"></span>
		  </div>
		</template>
		<template data-id="resultTemplate">
		  <div style="display: inline-block">
			<img><br/><span></span>
		  </div>
		</template>
		<br/>
        <a href="https://github.com/CompVis/stable-diffusion">Stable Diffusion</a> &nbsp;
		<a href="https://github.com/harubaru/waifu-diffusion">Waifu Diffusion</a> &nbsp;
		<a href="https://huggingface.co/naclbit/trinart_stable_diffusion_v2">trinart_stable_diffusion_v2</a> &nbsp;
		<a href="https://huggingface.co/doohickey/trinart-waifu-diffusion-50-50">trinart-waifu-diffusion-50-50</a>
		<a href="https://huggingface.co/sd-dreambooth-library/disco-diffusion-style">disco-diffusion-style</a> &nbsp;
	  </div>
      <!-- テキスト感情分析サービス -->
      <div id="tsa" aria-labelledby="tsaTab" class="tab-pane fade" role="tabpanel">
        <label>language<input data-id="language" class="form-control" size="20"type="text" value="ja"></label>
        <label>text<input data-id="text" class="form-control" size="80" type="text" value="今日はいい天気ですね"></label>
        <button data-id="execute" class="btn btn-success">分析</button>
        <br/>
        <label>results:</label><br/>
		<div data-id="services">
		</div>
		<br/>
        <a href="https://github.com/cl-tohoku/bert-japanese/tree/v1.0">BERT Models for Japanese NLP</a>
      </div>
      <!-- 継続型音声認識サービス -->
      <div id="csr" aria-labelledby="csrTab" class="tab-pane fade" role="tabpanel">
        <label>language<input data-id="language" class="form-control" type="text" value="ja"></label>
        <button data-id="execute" class="btn btn-success">開始</button>
        <br/>
        <label>results:</label><br/>
		<div data-id="services">
		</div>
		<br/>
        <a href="https://alphacephei.com/vosk/server">VOSK Server</a>
      </div>
      <!-- 音声認識サービス -->
      <div id="sr" aria-labelledby="srTab" class="tab-pane fade" role="tabpanel">
		<div data-id="inputs">
	        <label>language<input data-id="language" class="form-control" type="text" value="ja"></label>
			&nbsp;
			<label>audio<div>
	    	    <button data-id="execute" class="btn btn-success">録音</button>
				&nbsp;or&nbsp;
				<button data-id="button" effectAllowed="move" style="height: 3em" type="button"
		  			class="btn btn-sm btn-outline-success form-control-inline">ここにwavファイルをドロップしてください</button>
			</div></label>
		</div>
        <label>services:</label><br/>
		<div data-id="services">
		</div>
		<template data-id="serviceTemplate">
			<label><input data-id="serviceIdCheck" type="checkbox" checked>&nbsp;
				<span data-id="serviceIdLabel"></span></label><br/>
		</template>
		<label>results:</label>
		<div data-id="results">
		</div>
		<template data-id="resultTemplate">
			input: <audio data-id="audio" controls></audio> <a data-id="link">download</a>
			<div data-id="serviceResults">
			</div>
		</template>
		<template data-id="serviceResultTemplate">
			<span data-id="serviceId"></span><br/>
			<div data-id="recognitionResults"></div>
		</template>
		<template data-id="recognitionResultTemplate">
			[<span data-id="startMillis"></span> --> <span data-id="endMillis"></span>]
				<span data-id="transcript"></span><br/>
		</template>
		<br/>
        <a href="https://github.com/openai/whisper">Whisper</a>
      </div>
      <!-- 音声感情検出サービス -->
      <div id="ser" aria-labelledby="serTab" class="tab-pane fade" role="tabpanel">
		<label>inputs:</label><br/>
		<div data-id="inputs">
	        <!--label>language--><input data-id="language" class="form-control" type="hidden" value="ja"><!-- /label-->
			&nbsp;
			<label>audio<div>
	    	    <button data-id="execute" class="btn btn-success">録音</button>
				<select data-id="sampleRate">
					<option value="11025">11025</option>
					<option value="16000" selected>16000</option>
				</select>Hz
				&nbsp;or&nbsp;
				<button data-id="button" effectAllowed="move" style="height: 3em" type="button"
		  			class="btn btn-sm btn-outline-success form-control-inline">ここにwavファイルをドロップしてください</button>
			</div></label>
		</div>
        <label>services:</label><br/>
		<div data-id="services">
		</div>
		<template data-id="serviceTemplate">
			<label><input data-id="serviceIdCheck" type="checkbox" checked>&nbsp;
				<span data-id="serviceIdLabel"></span></label><br/>
		</template>
		<label>results:</label>
		<div data-id="results">
		</div>
		<template data-id="resultTemplate">
			input: <audio data-id="audio" controls></audio> <a data-id="link">download</a>
			<div data-id="serviceResults">
			</div>
		</template>
		<template data-id="serviceResultTemplate">
			<span data-id="serviceId"></span><br/>
			<div data-id="emotionRecognitionResults"></div>
		</template>
		<template data-id="emotionRecognitionResultTemplate">
			<span data-id="label"></span>(<span data-id="degree"></span>)<br/>
		</template>
		<br/>
        <a href="https://webempath.net/lp-jpn/">Empath</a>(11025Hz)&nbsp;
        <a href="https://github.com/speechbrain/speechbrain">SpeechBrain</a>(16000Hz)
      </div>
      <!-- 音声合成サービス -->
      <div id="tts" aria-labelledby="ttsTab" class="tab-pane fade" role="tabpanel">
        <label>language<input data-id="language" class="form-control" type="text" value="ja"></label>
        <label>text<input data-id="text" class="form-control" type="text" value="今日はいい天気ですね"></label>
        <button data-id="execute" class="btn btn-success">合成</button>
        <br/>
        <label>results:</label><br/>
		<div data-id="services">
		</div>
		<br/>
        <a href="https://cloud.google.com/text-to-speech">Google Cloud Text-to-Speech</a>
      </div>
    </div>
  </div></div>
</div>
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-bson/2.0.8/bson.min.js" integrity="sha512-3NRCDv4HSFtMd3OLtUOPmxOceZQuCtfhhGaTn3BpCn+wDEDRWOWeNGjL2Ahd6IrvlhH6kBpAHRzeU3AfKKvzkg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-bson/2.0.8/bson.js" integrity="sha512-qj4zC8FelR9yOqMc29m3TEARellBmX1gse6toliCJJ9vO8Pgy6FaFUwd/UU02Jv3U2ZTyKIjRe1+GQmUPDLAEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
-->
<script src="./bson.js"></script>
<script src="./serviceInvoker.js"></script>
<script src="./recorder.js"></script>
<script src="./wavwriter.js"></script>
<script src="./drawUtil.js"></script>
<script>
//const baseUrl = "https://langrid.org/mlgrid-services/services";
//const baseUrl = "http://localhost:8080/mlgrid-services/services";
const baseUrl = "services";

function round(v, n){
	const s = Math.pow(10, n);
	return Math.round(v * s) / s;
}

function roundBox(v, n){
	return {x: round(v.x, n), y: round(v.y, n),
		width: round(v.width, n), height: round(v.height, n)};
}

function msToMsms(ms){
	return `${Math.floor(ms / 1000 / 60)}:${ms / 1000 % 60}.${ms % 1000}`;
}

window.addEventListener("load", ()=>{
	const transServiceIds = ["LangridGoogleTranslateNMT", "HelsinkiNLPOpusMT"];
	const icServiceIds = ["KerasEfficientNetV2B0", "KerasResNet50", "KerasVGG19"];
	const odServiceIds = ["YoloV5n", "YoloV5s", "YoloV5m", "YoloV5l", "YoloV5x"];
//	const igServiceIds = ["DummyTextImageGeneration"];
	const igServiceIds = ["DalleMiniMega1Fp16", "DalleMiniMini1",
		"StableDiffusionSD041", "WaifuDiffusionSD030",
		"WaifuDiffusionSD041", "TrinartWaifuSD041",
		"DiscoDiffusionSD041", "TrinartStableDiffusionSD041", "RinnaJapaneseStableDiffusion"];
	const tsaServiceIds = ["ClTohokuSentimentAnalysis"];
	const csrServiceIds = ["VOSK"];//, "ChromeASR"];
	const srServiceIds = ["DummySpeechRecognition", "Whisper"];
	const serServiceIds = ["Empath", "SpeechBrainSER"];
	const ttsServiceIds = ["GoogleTTS"];
	const hpeServiceIds = ["OpenPose"];
	const i2iServiceIds = ["CodeFormer", "RealESRGAN"];
	const i2tServiceIds = ["ClipInterrogator"];
	const tgiServiceIds = ["StableDiffusionIMSD041", "WaifuDiffusionIMSD041",
		"TrinartStableDiffusionIMSD041", "TrinartWaifuIMSD041", "DiscoDiffusionIMSD041"];

	const bson = new BSON();
	const loc = document.location;
	const proto = loc.protocol == "https:" ? "wss" : "ws";
	const wsUrl = `${proto}://${loc.host}/${loc.pathname.split("/")[1]}/ws`
	console.debug(`ws url: ${wsUrl}`);
	const ws = new WSServiceInvoker(wsUrl);
	const rec = new Recorder();

	// 翻訳サービス
	{
		const parent = document.querySelector("#trans");
		const inputs = parent.querySelector("[data-id='inputs']");
		const sids = transServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const serviceTemplate = parent.querySelector("[data-id='serviceTemplate']");
		for(let sid of sids){
			const content = serviceTemplate.content.cloneNode(true);
			content.querySelector("[data-id='serviceIdCheck']").setAttribute("data-id", `${sid}Check`);
			content.querySelector("[data-id='serviceIdLabel']").textContent = sid;
			services.append(content);
		}

		const results = parent.querySelector("[data-id='results']");
		const resultTemplate = parent.querySelector("[data-id='resultTemplate']");
		parent.querySelector("[data-id='execute']").addEventListener("click", e=>{
			e.preventDefault();
			const sl = inputs.querySelector("[data-id='sourceLang']").value;
			const tl = inputs.querySelector("[data-id='targetLang']").value;
			const source = inputs.querySelector("[data-id='source']").value;
			const result = resultTemplate.content.cloneNode(true);
			result.querySelector("[data-id='sourceLang']").textContent = sl;
			result.querySelector("[data-id='targetLang']").textContent = tl;
			result.querySelector("[data-id='source']").textContent = source;
			const serviceResults = result.querySelector("[data-id='serviceResults']");
			const serviceResultTemplate = parent.querySelector("[data-id='serviceResultTemplate']");
			for(let sid of sids){
				const serviceResult = serviceResultTemplate.content.cloneNode(true);
				serviceResult.querySelector("[data-id='serviceId']").textContent = sid;
				const serviceResultResult = serviceResult.querySelector("[data-id='result']");
				serviceResultResult.textContent = "processing...";
				ws.translation(sid).translate(sl, tl, source)
					.then(r=>{ serviceResultResult.textContent = r.result; })
					.catch(e=>{ console.error(e); result.textContent = r.error; });
				serviceResults.append(serviceResult);
			}
			results.append(result);
		});
	}

	// 画像識別サービス
	const ic = document.querySelector("#ic");
	const icServices = ic.querySelector("#icServices");
	const icResults = {};
	for(let sid of icServiceIds){
		icServices.append(document.createTextNode(`${sid}: `));
		const r = document.createElement("span");
		icResults[sid] = r;
		icServices.append(r);
		icServices.append(document.createElement("br"));
	}
	const icButton = ic.querySelector("#icButton");
	icButton.addEventListener("dragover", e=>{
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = "link";
	});
	icButton.addEventListener("drop", e=>{
		e.preventDefault();
		const file = e.dataTransfer.files[0];
		ic.querySelector("#icImage").src = URL.createObjectURL(file);
		const fr = new FileReader();
//		fr.readAsDataURL(file);
		fr.readAsArrayBuffer(file);
		fr.addEventListener("load", e=>{
			for(let sid of icServiceIds){
				const result = icResults[sid];
				result.textContent = "processing...";
// [cat.jpg,497bytes] b64(DataURL): 663byte, bin: 497bytes
//				ws.imageClassification(sid).classify(sid, "image/jpeg", fr.result.split(",")[1], "en", 10)
				ws.imageClassification(sid).classify("image/jpeg", Buffer.from(new Uint8Array(fr.result)), "en", 10)
					.then(r=>{result.textContent = r.result.map(
						a=>`${a["label"]}(${round(a["accuracy"], 2)})`).join(",")})
					.catch(e=>{ console.error(e); result.textContent = e.error; });
			}
		});
	});

	// 物体検出サービス
	const od = document.querySelector("#od");
	const odServices = od.querySelector("#odServices");
	const odResults = {};
	for(let sid of odServiceIds){
		odServices.append(document.createTextNode(`${sid}: `));
		const r = document.createElement("span");
		odResults[sid] = r;
		odServices.append(r);
		odServices.append(document.createElement("br"));
	}
	const odButton = od.querySelector("#odButton");
	odButton.addEventListener("dragover", e=>{
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = "link";
	});
	odButton.addEventListener("drop", e=>{
		e.preventDefault();
		const file = e.dataTransfer.files[0];
		od.querySelector("#odImage").src = URL.createObjectURL(file);
		const fr = new FileReader();
		fr.readAsArrayBuffer(file);
		fr.addEventListener("load", e=>{
			for(let sid of odServiceIds){
				const result = odResults[sid];
				result.textContent = "processing...";
				ws.objectDetection(sid).detect("image/jpeg", Buffer.from(new Uint8Array(fr.result)), "en", 10)
					.then(r=>{result.textContent = r.result.map(
						a=>`${JSON.stringify(roundBox(a["boundingBox"], 2))},${a["label"]}(${round(a["accuracy"], 2)})`).join("\n")})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	});

	{	// HumanPoseEstimation
		const parent = document.querySelector("#hpe");
		const sids = hpeServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const canvases = parent.querySelector("[data-id='canvases']");
		const results = {};
		for(let sid of sids){
			services.append(document.createTextNode(`${sid}: `));
			const r = document.createElement("span");
			const c = document.createElement("canvas");
			c.style.position = "absolute";
			c.style.left = "0px";
			c.style.top = "0px";
			results[sid] = {text: r, canvas: c};
			services.append(r);
			services.append(document.createElement("br"));
			canvases.append(c);
		}
		const button = parent.querySelector("[data-id='button']");
		button.addEventListener("dragover", e=>{
			e.stopPropagation();
			e.preventDefault();
			e.dataTransfer.dropEffect = "link";
		});
		button.addEventListener("drop", e=>{
			e.preventDefault();
			const file = e.dataTransfer.files[0];
			const srcImage = parent.querySelector("[data-id='image']");
			srcImage.src = URL.createObjectURL(file);
			const fr = new FileReader();
			fr.readAsArrayBuffer(file);
			fr.addEventListener("load", e=>{
				for(let sid of sids){
					const result = results[sid];
					result["text"].textContent = "processing...";
					const canvas = result["canvas"];
					const ctx = canvas.getContext('2d');
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					ws.humanPoseEstimation(sid).estimate("image/jpeg", Buffer.from(new Uint8Array(fr.result)), 100)
						.then(r=>{
							const scale = srcImage.width / srcImage.naturalWidth;
							result["text"].textContent = JSON.stringify(r.result);
							const canvas = result["canvas"];
							canvas.width = srcImage.width;
							canvas.height = srcImage.height;
							const ctx = canvas.getContext('2d');
							for(const pose of r.result){
								drawPose(ctx, scale, pose);
							}
						})
						.catch(e=>{ console.error(e); result.textContent = e.error; });
				}
			});
		});
	}

	{	// ImageToImageConversion
		const parent = document.querySelector("#i2i");
		const sids = i2iServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const serviceTemplate = parent.querySelector("[data-id='serviceTemplate']");
		for(let sid of sids){
			const content = serviceTemplate.content.cloneNode(true);
			content.querySelector("[data-id='serviceIdCheck']").setAttribute("data-value", `${sid}`);
			content.querySelector("[data-id='serviceIdLabel']").textContent = sid;
			services.append(content);
		}

		const results = parent.querySelector("[data-id='results']");
		const resultTemplate = parent.querySelector("[data-id='resultTemplate']");
		const serviceResultTemplate = parent.querySelector("[data-id='serviceResultTemplate']");
		const button = parent.querySelector("[data-id='button']");
		button.addEventListener("dragover", e=>{
			e.stopPropagation();
			e.preventDefault();
			e.dataTransfer.dropEffect = "link";
		});
		button.addEventListener("drop", e=>{
			e.preventDefault();
			const file = e.dataTransfer.files[0];
			const result = resultTemplate.content.cloneNode(true);
			result.querySelector("[data-id='image']").src = URL.createObjectURL(file);
			const srs = result.querySelector("[data-id='serviceResults']");
			const fr = new FileReader();
			fr.readAsArrayBuffer(file);
			fr.addEventListener("load", e=>{
				for(let sid of sids){
					if(!parent.querySelector(`[data-value='${sid}']`).checked) continue;
					const sr = serviceResultTemplate.content.cloneNode(true);
					sr.querySelector("[data-id='serviceId']").textContent = sid;
					const srStatus = sr.querySelector("[data-id='status']");
					const srImg = sr.querySelector("[data-id='conversionResult']");
					srStatus.textContent = "processing...";
					ws.imageToImageConversion(sid).convert("image/jpeg", Buffer.from(new Uint8Array(fr.result)))
						.then(r=>{
							srStatus.textContent = "done.";
							srImg.src = URL.createObjectURL(new Blob([r.result.image.buffer]));
						})
						.catch(e=>{ console.error(e); result["state"].textContent = e.error; });
					srs.append(sr);
				}
			});
			results.append(result);
		});
	}

	{	// ImageToTextGeneration
		const parent = document.querySelector("#i2t");
		const sids = i2tServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const serviceTemplate = parent.querySelector("[data-id='serviceTemplate']");
		for(let sid of sids){
			const content = serviceTemplate.content.cloneNode(true);
			content.querySelector("[data-id='serviceIdCheck']").setAttribute("data-id", `${sid}Check`);
			content.querySelector("[data-id='serviceIdLabel']").textContent = sid;
			services.append(content);
		}

		const results = parent.querySelector("[data-id='results']");
		const resultTemplate = parent.querySelector("[data-id='resultTemplate']");
		const serviceResultTemplate = parent.querySelector("[data-id='serviceResultTemplate']");
		const button = parent.querySelector("[data-id='button']");
		button.addEventListener("dragover", e=>{
			e.stopPropagation();
			e.preventDefault();
			e.dataTransfer.dropEffect = "link";
		});
		button.addEventListener("drop", e=>{
			e.preventDefault();
			const file = e.dataTransfer.files[0];
			const result = resultTemplate.content.cloneNode(true);
			result.querySelector("[data-id='image']").src = URL.createObjectURL(file);
			const serviceResults = result.querySelector("[data-id='serviceResults']");
			const fr = new FileReader();
			fr.readAsArrayBuffer(file);
			fr.addEventListener("load", e=>{
				for(let sid of sids){
					const sr = serviceResultTemplate.content.cloneNode(true);
					sr.querySelector("[data-id='serviceId']").textContent = sid;
					const gr = sr.querySelector("[data-id='generationResult']");
					gr.textContent = "processing...";
					ws.imageToTextGeneration(sid).generate("image/jpeg", Buffer.from(new Uint8Array(fr.result)))
						.then(r=>{
							gr.textContent = r.result;
						})
						.catch(e=>{ console.error(e); gr.textContent = e.error; });
					serviceResults.append(sr);
				}
			});
			results.append(result);
		});
	}

	{	// TextImageGeneration
		const parent = document.querySelector("#ig");
		const services = parent.querySelector("[data-id='services']");
		const sids = igServiceIds;
		const results = {};
		for(let sid of sids){
			const content = parent.querySelector("[data-id='serviceTemplate']").content.cloneNode(true);
			const serviceId = content.querySelector("[data-id='serviceId'");
			serviceId.setAttribute("data-value", `${sid}`);
			serviceId.append(document.createTextNode(`${sid}`));
			results[sid] = content.querySelector("div");
			services.append(content);
		}
		parent.querySelector("[data-id='execute']").addEventListener("click", e=>{
			e.preventDefault();
			const lang = parent.querySelector("[data-id='language']").value;
			const text = parent.querySelector("[data-id='text']").value;
			const samples = parent.querySelector("[data-id='samples']").value;
			for(let sid of sids){
				if(!document.querySelector(`[data-value='${sid}'] input`).checked) continue;
				const result = results[sid];
				result.querySelector("[data-id='status']").textContent = "processing...";
				ws.textGuildedImageGeneration(sid).generateMultiTimes(lang, text, samples)
					.then(r=>{
						result.querySelector("[data-id='status']").textContent = "done.";
						result.append(document.createElement("br"));
						for(let res of r.result){
							const content = parent.querySelector("[data-id='resultTemplate']").content.cloneNode(true);
							const img = content.querySelector("img");
							img.src = URL.createObjectURL(new Blob([res.image.buffer]));
							result.append(content);
						}
					})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	}

	{	// TextGuidedImageManipulateion
		const parent = document.querySelector("#tgi");
		const services = parent.querySelector("[data-id='services']");
		const sids = tgiServiceIds;
		const results = {};
		for(let sid of sids){
			const content = parent.querySelector("[data-id='serviceTemplate']").content.cloneNode(true);
			const serviceId = content.querySelector("[data-id='serviceId'");
			serviceId.setAttribute("data-value", `${sid}`);
			serviceId.append(document.createTextNode(`${sid}`));
			results[sid] = content.querySelector("div");
			services.append(content);
		}
		const button = parent.querySelector("[data-id='button']");
		button.addEventListener("dragover", e=>{
			e.stopPropagation();
			e.preventDefault();
			e.dataTransfer.dropEffect = "link";
		});
		button.addEventListener("drop", e=>{
			e.preventDefault();
			const lang = parent.querySelector("[data-id='language']").value;
			const prompt = parent.querySelector("[data-id='prompt']").value;
			const file = e.dataTransfer.files[0];
			const srcImage = parent.querySelector("[data-id='image']");
			if(srcImage.src) URL.revokeObjectURL(srcImage.src);
			srcImage.src = URL.createObjectURL(file);
			const fr = new FileReader();
			fr.readAsArrayBuffer(file);
			fr.addEventListener("load", e=>{
				for(let sid of sids){
					if(!parent.querySelector(`[data-value='${sid}'] input`).checked) continue;
					const result = results[sid];
					result.querySelector("[data-id='status']").textContent = "processing...";
					ws.textGuidedImageManipulation(sid).manipulate(
						lang, prompt, "image/png", Buffer.from(new Uint8Array(fr.result)))
						.then(r=>{
							result.querySelector("[data-id='status']").textContent = "done.";
							let img = result.querySelector("img");
							if(!img){
								img = document.createElement("img");
								result.append(img);
							} else{
								URL.revokeObjectURL(img.src);
							}
							img.src = URL.createObjectURL(new Blob([r.result.image.buffer]));
							img.width = srcImage.width;
							img.height = srcImage.height;
						})
						.catch(e=>{ console.error(e); result["state"].textContent = e.error; });
				}
			});
		});
	}

	{	// TextSentimentAnalysis
		const parent = document.querySelector("#tsa");
		const sids = tsaServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const results = {};
		for(let sid of sids){
			services.append(document.createTextNode(`${sid}: `));
			const r = document.createElement("span");
			results[sid] = r;
			services.append(r);
			services.append(document.createElement("br"));
		}
		parent.querySelector("[data-id='execute']").addEventListener("click", e=>{
			e.preventDefault();
			const lang = parent.querySelector("[data-id='language']").value;
			const text = parent.querySelector("[data-id='text']").value;
			for(let sid of sids){
				const result = results[sid];
				result.textContent = "processing...";
				ws.textSentimentAnalysis(sid).analyze(lang, text)
					.then(r=>{
						result.textContent = `${r.result.label}(${round(r.result.accuracy, 2)})`;
					})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	}

	{	// ContinuousSpeechRecognition
		const parent = document.querySelector("#csr");
		const sids = csrServiceIds;
		const resultContainer = parent.querySelector("[data-id='services']");
		const services = {};
		for(let sid of sids){
			const s = {};
			services[sid] = s;
			resultContainer.append(document.createTextNode(`${sid}: `));
			const resultsDiv = document.createElement("div");
			resultContainer.append(resultsDiv);
			resultContainer.append(document.createElement("br"));
			s.resultsDiv = resultsDiv;
		}
		let recorder = null;
		const exeBtn = parent.querySelector("[data-id='execute']");
		exeBtn.addEventListener("click", e=>{
			e.preventDefault();
			if(recorder){
				// 停止する
				recorder.stop();
				recorder = null;
				exeBtn.textContent = "開始";
				return;
			}
			// 開始する
			exeBtn.textContent = "停止";
			recorder = new Recorder();
			const receiver = s=>{ return r=>{
				for(let result of r.result){
					let sentenceSpan = s.resultsDiv.querySelector(`[data-sentence-id="${result.sentenceId}"]`);
					if(!sentenceSpan){
						sentenceSpan = document.createElement("span");
						sentenceSpan.setAttribute("data-sentence-id", result.sentenceId);
						s.resultsDiv.append(document.createElement("br"));
						s.resultsDiv.append(sentenceSpan);
					}
					if(result.sentence){
						sentenceSpan.textContent = `${result.sentence}(${round(result.accuracy, 2)})`;
					}
				}
			}; };
			recorder.onStartRecording = (stream, audioContext)=>{
				const lang = parent.querySelector(`[data-id="language"]`).value;
				for(let sid of sids){
					const s = services[sid];
					const config = {
						channels: 1,
						sampleSizeInBits: 16,
						sampleRate: 16000 // audioContext.sampleRate  // hertz. 8000, 16000, 44100.
					};
					ws.continuousSpeechRecognition(sid).startRecognition(lang, config)
						.then(r=>{
							while (s.resultsDiv.firstChild) {
     						   s.resultsDiv.removeChild(s.resultsDiv.firstChild);
							}
							s.resultsDiv.append(document.createElement("span"));
							s.resultsDiv.firstChild.textContent = "processing...";
							s.started = true;
							s.sessionId = r.result;
						})
						.catch(e=>{
							console.error(e);
							s.resultsDiv.textContent = r.error;
							recorder.stop();
						});
				}
			};
			recorder.onProcessRecording = channelData =>{
				for(let sid of sids){
					const s = services[sid];
					if(s.sessionId == null){
						console.debug("skip service because sessionId is null.")
						continue;
					}
					if(s.started){
						const data = downsampleBuffer(channelData, recorder.getAudioContext().sampleRate, 16000);
						ws.continuousSpeechRecognition(sid)
							.processRecognition(s.sessionId, Buffer.from(data))
							.then(receiver(s))
							.catch(e=>{
								console.error(e);
								s.resultsDiv.append(document.createTextNode(e.error));
								recorder.stop();
							});
					}
				}
			};
			recorder.onStopRecording = ()=>{
				for(let sid of sids){
					const s = services[sid];
					ws.continuousSpeechRecognition(sid)
						.stopRecognition(s.sessionId)
						.then(receiver(s))
						.catch(e=>{
							console.error(e);
							s.resultsDiv.append(document.createTextNode(e.error));
							recorder.stop();
						});
					s.resultsDiv.removeChild(s.resultsDiv.firstChild);
				}
			};
			recorder.start();
		});
	}

	{	// SpeechRecognition
		const parent = document.querySelector("#sr");
		const inputs = parent.querySelector("[data-id='inputs']");
		const sids = srServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const serviceTemplate = parent.querySelector("[data-id='serviceTemplate']");
		for(let sid of sids){
			const content = serviceTemplate.content.cloneNode(true);
			content.querySelector("[data-id='serviceIdCheck']").setAttribute("data-id", `${sid}Check`);
			content.querySelector("[data-id='serviceIdLabel']").textContent = sid;
			services.append(content);
		}
		const results = parent.querySelector("[data-id='results']");
		const resultTemplate = parent.querySelector("[data-id='resultTemplate']");

		const go = (lang, wav)=>{
			const dataUrl = URL.createObjectURL(new Blob(
		            [wav], {type: "audio/wav"}));
			const result = resultTemplate.content.cloneNode(true);
			result.querySelector("[data-id='audio']").src = dataUrl;
			result.querySelector("[data-id='link']").href = dataUrl;
			const serviceResults = result.querySelector("[data-id='serviceResults']");
			results.append(result);
			const serviceResultTemplate = parent.querySelector("[data-id='serviceResultTemplate']");
			const recognitionResultTemplate = parent.querySelector("[data-id='recognitionResultTemplate']");
			for(const sid of sids){
				if(!services.querySelector(`[data-id='${sid}Check']`).checked) continue;
				ws.speechRecognition(sid).recognize(lang, "audio/x-wav", Buffer.from(wav))
					.then(ret => {
						console.log(ret);
						const sr = serviceResultTemplate.content.cloneNode(true);
						sr.querySelector("[data-id='serviceId']").textContent = sid;
						const recognitionResults = sr.querySelector("[data-id='recognitionResults']");
						serviceResults.append(sr);
						for(const r of ret.result){
							const rr = recognitionResultTemplate.content.cloneNode(true);
							rr.querySelector("[data-id='startMillis']").textContent = msToMsms(r.startMillis);
							rr.querySelector("[data-id='endMillis']").textContent = msToMsms(r.endMillis);
							rr.querySelector("[data-id='transcript']").textContent = r.transcript;
							recognitionResults.append(rr);
						}
					});
			}
		};

		const button = parent.querySelector("[data-id='button']");
		button.addEventListener("dragover", e=>{
			e.preventDefault();
			e.dataTransfer.dropEffect = "link";
		});
		button.addEventListener("drop", e=>{
			e.preventDefault();
			const fr = new FileReader();
			fr.readAsArrayBuffer(e.dataTransfer.files[0]);
			fr.addEventListener("load", e=>{
				const lang = inputs.querySelector("[data-id='language']").value;
				go(lang, fr.result);
			});
		});

		let recorder = null;
		const exeBtn = parent.querySelector("[data-id='execute']");
		exeBtn.addEventListener("click", e=>{
			e.preventDefault();
			if(recorder){
				// 停止する
				recorder.stop();
				recorder = null;
				exeBtn.textContent = "開始";
				return;
			}
			// 開始する
			exeBtn.textContent = "停止";
			recorder = new Recorder();
			const targetSampleRate = 16000;
			let wavWriter = new WavWriter();
			recorder.onStartRecording = (stream, audioContext)=>{
				sampleRate = audioContext.sampleRate;
		        wavWriter = new WavWriter({sampleRate: targetSampleRate});
			};
			recorder.onProcessRecording = channelData=>{
				const uint8buff = downsampleBuffer(channelData,
	            	recorder.getAudioContext().sampleRate,
    	    	    targetSampleRate);
		        wavWriter.addData(uint8buff);
			};
			recorder.onStopRecording = ()=>{
				const wavFile = wavWriter.getWavFile();
				wavwriter = null;
				const lang = inputs.querySelector("[data-id='language']").value;
				go(lang, wavFile);
			};
			recorder.start(targetSampleRate);
		});
	}

	{	// SpeechEmotionRecognition
		const parent = document.querySelector("#ser");
		const inputs = parent.querySelector("[data-id='inputs']");
		const sids = serServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const serviceTemplate = parent.querySelector("[data-id='serviceTemplate']");
		for(let sid of sids){
			const content = serviceTemplate.content.cloneNode(true);
			content.querySelector("[data-id='serviceIdCheck']").setAttribute("data-id", `${sid}Check`);
			content.querySelector("[data-id='serviceIdLabel']").textContent = sid;
			services.append(content);
		}
		const results = parent.querySelector("[data-id='results']");
		const resultTemplate = parent.querySelector("[data-id='resultTemplate']");

		const go = (lang, wav)=>{
			const dataUrl = URL.createObjectURL(new Blob(
		            [wav], {type: "audio/wav"}));
			const result = resultTemplate.content.cloneNode(true);
			result.querySelector("[data-id='audio']").src = dataUrl;
			result.querySelector("[data-id='link']").href = dataUrl;
			const serviceResults = result.querySelector("[data-id='serviceResults']");
			results.append(result);
			const serviceResultTemplate = parent.querySelector("[data-id='serviceResultTemplate']");
			const recognitionResultTemplate = parent.querySelector("[data-id='emotionRecognitionResultTemplate']");
			for(const sid of sids){
				if(!services.querySelector(`[data-id='${sid}Check']`).checked) continue;
				ws.speechRecognition(sid).recognize(lang, "audio/x-wav", Buffer.from(wav))
					.then(ret => {
						console.log(ret);
						const sr = serviceResultTemplate.content.cloneNode(true);
						sr.querySelector("[data-id='serviceId']").textContent = sid;
						const recognitionResults = sr.querySelector("[data-id='emotionRecognitionResults']");
						serviceResults.append(sr);
						for(const r of ret.result){
							const rr = recognitionResultTemplate.content.cloneNode(true);
							rr.querySelector("[data-id='label']").textContent = r.label;
							rr.querySelector("[data-id='degree']").textContent = r.degree;
							recognitionResults.append(rr);
						}
					});
			}
		};

		const button = parent.querySelector("[data-id='button']");
		button.addEventListener("dragover", e=>{
			e.preventDefault();
			e.dataTransfer.dropEffect = "link";
		});
		button.addEventListener("drop", e=>{
			e.preventDefault();
			const fr = new FileReader();
			fr.readAsArrayBuffer(e.dataTransfer.files[0]);
			fr.addEventListener("load", e=>{
				const lang = inputs.querySelector("[data-id='language']").value;
				go(lang, fr.result);
			});
		});

		let recorder = null;
		const exeBtn = parent.querySelector("[data-id='execute']");
		exeBtn.addEventListener("click", e=>{
			e.preventDefault();
			if(recorder){
				// 停止する
				recorder.stop();
				recorder = null;
				exeBtn.textContent = "開始";
				return;
			}
			// 開始する
			exeBtn.textContent = "停止";
			recorder = new Recorder();
			const targetSampleRate = inputs.querySelector("[data-id='sampleRate']").value;
			let wavWriter = new WavWriter();
			recorder.onStartRecording = (stream, audioContext)=>{
				sampleRate = audioContext.sampleRate;
		        wavWriter = new WavWriter({sampleRate: targetSampleRate});
			};
			recorder.onProcessRecording = channelData=>{
				const uint8buff = downsampleBuffer(channelData,
	            	recorder.getAudioContext().sampleRate,
    	    	    targetSampleRate);
		        wavWriter.addData(uint8buff);
			};
			recorder.onStopRecording = ()=>{
				const wavFile = wavWriter.getWavFile();
				wavwriter = null;
				const lang = inputs.querySelector("[data-id='language']").value;
				go(lang, wavFile);
			};
			recorder.start(targetSampleRate);
		});
	}

	{	// TextToSpeech
		const parent = document.querySelector("#tts");
		const sids = ttsServiceIds;
		const services = parent.querySelector("[data-id='services']");
		const results = {};
		for(let sid of sids){
			services.append(document.createTextNode(`${sid}: `));
			const r = document.createElement("span");
			results[sid] = r;
			services.append(r);
			services.append(document.createElement("br"));
		}
		parent.querySelector("[data-id='execute']").addEventListener("click", e=>{
			e.preventDefault();
			const lang = parent.querySelector("[data-id='language']").value;
			const text = parent.querySelector("[data-id='text']").value;
			for(let sid of sids){
				const result = results[sid];
				result.textContent = "processing...";
				ws.textToSpeech(sid).speak(lang, text, "", "audio/mpeg")
					.then(r=>{
						result.textContent = "";
						const audio = document.createElement("audio");
						audio.controls = true;
						console.log(r.result.audio.buffer.buffer);
						audio.src = URL.createObjectURL(new Blob(
							[r.result.audio.buffer], {type: r.result.audioType}));
						result.appendChild(audio);
					})
					.catch(e=>{ console.error(e); result.textContent = r.error; });
			}
		});
	}
});

</script>
</body>
</html>
